<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scenario Planner</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; background: #f9fafb; color: #111827; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { padding: 0.5rem; text-align: center; border: 1px solid #d1d5db; }
    th { background-color: #3b82f6; color: white; }
    input, select { width: 100%; padding: 0.3rem; }
    button { padding: 0.5rem 1rem; margin-right: 0.5rem; margin-top: 1rem; }
    .warning { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    tfoot td { font-weight: bold; background-color: #f3f4f6; }
    #chart-container { max-width: 600px; margin: 2rem auto; }
    .button-group { margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Scenario Planner</h1>

  <label>Total Budget: <input type="number" id="totalBudget" value="1000000"></label>
  <br><br>
  <label>Currency:
    <select id="currency">
      <option value="RM">RM</option>
      <option value="$">$</option>
      <option value="€">€</option>
      <option value="£">£</option>
      <option value="¥">¥</option>
    </select>
  </label>
  <br><br>
  <label>Target GMV: <input type="number" id="targetGMV" value="2000000"></label><br><br>
  <label>Allocation Method:
    <select id="method">
      <option value="proportional">ROAS Proportional</option>
      <option value="equally">Allocate Equally</option>
      <option value="maximize">Maximize GMV</option>
    </select>
  </label>
  <br><br>

  <table id="inputTable">
    <thead>
      <tr>
        <th>Channel</th>
        <th>ROAS</th>
        <th>Manual Budget %</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input value="SEM"></td>
        <td><input type="number" value="10"></td>
        <td><input type="number"></td>
        <td><button onclick="deleteRow(this)">🗑️</button></td>
      </tr>
      <tr>
        <td><input value="Online Display"></td>
        <td><input type="number" value="15"></td>
        <td><input type="number"></td>
        <td><button onclick="deleteRow(this)">🗑️</button></td>
      </tr>
      <tr>
        <td><input value="Meta"></td>
        <td><input type="number" value="5"></td>
        <td><input type="number"></td>
        <td><button onclick="deleteRow(this)">🗑️</button></td>
      </tr>
      <tr>
        <td><input value="Google"></td>
        <td><input type="number" value="12"></td>
        <td><input type="number"></td>
        <td><button onclick="deleteRow(this)">🗑️</button></td>
      </tr>
      <tr>
        <td><input value="Tiktok"></td>
        <td><input type="number" value="17"></td>
        <td><input type="number"></td>
        <td><button onclick="deleteRow(this)">🗑️</button></td>
      </tr>
    </tbody>
  </table>

  <div class="button-group">
    <button onclick="addNewRow()">➕ Add New Row</button>
    <button onclick="allocateBudget()">✅ Allocate Budget</button>
    <button onclick="exportCSV()">📤 Export CSV</button>
    <button onclick="saveDataPrompt()">💾 Save Slot</button>
    <button onclick="loadDataPrompt()">📥 Load Slot</button>
    <button onclick="downloadSettings()">⬇️ Download Setting</button>
    <button onclick="uploadSettings()">⬆️ Upload Setting</button>
    <input type="file" id="uploadFile" style="display:none" onchange="handleFileUpload(event)">
  </div>

  <h2>Output</h2>
  <table id="outputTable">
    <thead>
      <tr>
        <th>Channel</th>
        <th>Budget %</th>
        <th>Budget</th>
        <th>ROAS</th>
        <th>GMV</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td>Total</td>
        <td id="totalPercent">0%</td>
        <td id="totalBudgetUsed">0</td>
        <td></td>
        <td id="totalGMV">0</td>
      </tr>
    </tfoot>
  </table>

  <div><strong>Total ROAS:</strong> <span id="totalROAS">0</span></div>
  <div id="gmvWarning"></div>
  <div id="budgetWarning"></div>

  <div id="chart-container">
    <h3>Estimated GMV by Channel</h3>
    <canvas id="gmvChart"></canvas>
  </div>

  <script>
    const savedSettings = {};

    function saveDataPrompt() {
      const slot = prompt("Enter setting name to save (1-5):");
      if (!slot) return;
      savedSettings[slot] = serializeSettings();
      alert(`Saved to "${slot}".`);
    }

    function loadDataPrompt() {
      const slot = prompt("Enter setting name to load (1-5):");
      if (!slot || !savedSettings[slot]) {
        alert("Setting not found.");
        return;
      }
      deserializeSettings(savedSettings[slot]);
    }

    function downloadSettings() {
      const data = JSON.stringify(serializeSettings(), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'scenario_settings.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadSettings() {
      document.getElementById('uploadFile').click();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          deserializeSettings(data);
        } catch (err) {
          alert("Invalid file format.");
        }
      };
      reader.readAsText(file);
    }

    function serializeSettings() {
      const rows = document.querySelectorAll('#inputTable tbody tr');
      const channels = Array.from(rows).map(row => ({
        channel: row.cells[0].children[0].value,
        roas: row.cells[1].children[0].value,
        percent: row.cells[2].children[0].value
      }));
      return {
        budget: document.getElementById('totalBudget').value,
        gmv: document.getElementById('targetGMV').value,
        currency: document.getElementById('currency').value,
        method: document.getElementById('method').value,
        channels
      };
    }

    function deserializeSettings(data) {
      document.getElementById('totalBudget').value = data.budget;
      document.getElementById('targetGMV').value = data.gmv;
      document.getElementById('currency').value = data.currency;
      document.getElementById('method').value = data.method;

      const tbody = document.querySelector('#inputTable tbody');
      tbody.innerHTML = '';
      data.channels.forEach(({ channel, roas, percent }) => {
        addNewRow(channel, roas, percent);
      });
    }
  </script>
</body>
</html>
