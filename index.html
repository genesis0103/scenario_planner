<!DOCTYPE html>
<html>
<head>
  <title>Ad Budget Allocator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    input { margin: 5px; width: 100px; }
    .channel { margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    #result { margin-top: 20px; }
    button { margin: 5px; }
  </style>
</head>
<body>
  <h1>Ad Budget Allocator</h1>

  <label>Total Budget: $</label>
  <input type="number" id="totalBudget" placeholder="1000"><br><br>

  <div id="channels"></div>
  <button onclick="addChannel()">Add Channel</button>
  <button onclick="allocateBudget()">Allocate Budget</button>
  <button onclick="exportCSV()">Export CSV</button>

  <div id="result"></div>

  <script>
    let channelCount = 0;

    function addChannel(name = '', roi = '', min = '', max = '') {
      const div = document.createElement('div');
      div.className = 'channel';
      div.innerHTML = `
        <label>Channel Name: </label>
        <input type="text" class="name" value="${name}" placeholder="e.g. Facebook">
        <label>ROI: </label>
        <input type="number" step="0.01" class="roi" value="${roi}" placeholder="e.g. 1.5">
        <label>Min: </label>
        <input type="number" step="0.01" class="min" value="${min}" placeholder="Optional">
        <label>Max: </label>
        <input type="number" step="0.01" class="max" value="${max}" placeholder="Optional">
        <button onclick="removeChannel(this)">Remove</button>
      `;
      document.getElementById('channels').appendChild(div);
      channelCount++;
    }

    function removeChannel(btn) {
      btn.parentElement.remove();
      channelCount--;
    }

    function allocateBudget() {
      const budget = parseFloat(document.getElementById("totalBudget").value);
      const names = document.querySelectorAll(".name");
      const rois = document.querySelectorAll(".roi");
      const mins = document.querySelectorAll(".min");
      const maxs = document.querySelectorAll(".max");

      let data = [];

      for (let i = 0; i < names.length; i++) {
        const name = names[i].value.trim() || `Channel ${i + 1}`;
        const roi = parseFloat(rois[i].value);
        const min = parseFloat(mins[i].value);
        const max = parseFloat(maxs[i].value);

        if (isNaN(roi) || roi <= 0) {
          document.getElementById("result").innerHTML = "<p style='color:red;'>Please enter valid ROI values.</p>";
          return;
        }

        data.push({ name, roi, min: isNaN(min) ? 0 : min, max: isNaN(max) ? Infinity : max });
      }

      const totalROI = data.reduce((sum, d) => sum + d.roi, 0);

      let remaining = budget;
      let allocations = [];

      // First allocate proportional
      data.forEach(d => {
        const rawAlloc = (d.roi / totalROI) * budget;
        const clamped = Math.min(Math.max(rawAlloc, d.min), d.max);
        allocations.push({ ...d, allocated: clamped });
        remaining -= clamped;
      });

      // If there is leftover budget, distribute again respecting min/max
      while (remaining > 0.01) {
        let distributed = false;
        for (let i = 0; i < allocations.length; i++) {
          let a = allocations[i];
          let extra = ((a.roi / totalROI) * budget) - a.allocated;
          if (extra > 0 && a.allocated + extra <= a.max) {
            let add = Math.min(extra, remaining);
            allocations[i].allocated += add;
            remaining -= add;
            distributed = true;
          }
        }
        if (!distributed) break; // No place to put remaining
      }

      // Output result
      let output = "<h2>Budget Allocation</h2><table border='1' cellpadding='5'><tr><th>Channel</th><th>ROI</th><th>Allocated ($)</th></tr>";
      allocations.forEach(d => {
        output += `<tr><td>${d.name}</td><td>${d.roi}</td><td>${d.allocated.toFixed(2)}</td></tr>`;
      });
      output += `</table><p>Total Allocated: $${(budget - remaining).toFixed(2)} / $${budget}</p>`;
      document.getElementById("result").innerHTML = output;

      window.allocatedData = allocations; // store globally for export
    }

    function exportCSV() {
      if (!window.allocatedData) {
        alert("Please allocate the budget first.");
        return;
      }

      let csv = "Channel,ROI,Allocated Budget\n";
      window.allocatedData.forEach(d => {
        csv += `${d.name},${d.roi},${d.allocated.toFixed(2)}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "budget_allocation.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Add default channels
    addChannel('Facebook', 1.5);
    addChannel('Google', 2.0);
    addChannel('TikTok', 1.2);
  </script>
</body>
</html>
